name: Gemini API Auto Report

on:
  push:
    branches: [ main ]
  workflow_dispatch: # Tombol manual untuk cek kapan saja
  schedule:
    - cron: '0 0 * * *' # Berjalan otomatis setiap tengah malam

jobs:
  build-and-report:
    runs-on: ubuntu-latest
    permissions:
      contents: write # Penting agar bot bisa menulis file ke repo
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install SDK
        run: pip install -U google-generativeai

      - name: Generate API Report
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          python -c "
          import google.generativeai as genai
          import os
          from datetime import datetime

          api_key = os.getenv('GEMINI_API_KEY')
          genai.configure(api_key=api_key)

          with open('API_REPORT.md', 'w') as f:
              f.write(f'# Laporan API Gemini Terkini\n')
              f.write(f'Terakhir diperbarui: {datetime.now().strftime(\"%Y-%m-%d %H:%M:%S\")} GMT\n\n')
              f.write('| Nama Model (ID) | Nama Tampilan | Metode Dukungan |\n')
              f.write('| :--- | :--- | :--- |\n')
              
              try:
                  for m in genai.list_models():
                      methods = ', '.join(m.supported_generation_methods)
                      f.write(f'| `{m.name}` | {m.display_name} | {methods} |\n')
                  print('Laporan berhasil dibuat.')
              except Exception as e:
                  f.write(f'\n\n> **ERROR:** Gagal mengambil data. Periksa apakah API KEY valid. \nDetail: {e}')
          "

      - name: Commit and Push Report
        run: |
          git config --global user.name "Gemini-Autobot"
          git config --global user.email "bot@github.com"
          git add API_REPORT.md
          git commit -m "Update API Report [skip ci]" || echo "No changes to commit"
          git push
