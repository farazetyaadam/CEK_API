name: Gemini API Auto Report

on:
  push:
    branches: [ main ]
  workflow_dispatch: 
  schedule:
    - cron: '0 0 * * *'

jobs:
  build-and-report:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install SDK
        run: pip install -U google-generativeai

      - name: Generate API Report
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          python -c "
          import google.generativeai as genai
          import os
          from datetime import datetime

          # Konfigurasi API
          api_key = os.getenv('GEMINI_API_KEY')
          if not api_key:
              with open('API_REPORT.md', 'w') as f:
                  f.write('# ‚ùå ERROR: API KEY TIDAK DITEMUKAN\n\nPastikan Anda sudah menambahkan `GEMINI_API_KEY` di GitHub Secrets.')
              exit(0)

          genai.configure(api_key=api_key)
          time_now = datetime.now().strftime('%d %B %Y | %H:%M:%S')

          with open('API_REPORT.md', 'w') as f:
              f.write('# üìä LAPORAN STATUS API GEMINI\n\n')
              f.write(f'> **Update Terakhir:** {time_now} GMT\n\n')
              
              f.write('### ‚úÖ Model yang Siap Digunakan (generateContent)\n')
              f.write('Salin ID Model di bawah ini untuk digunakan di skrip otonom Anda:\n\n')
              f.write('| ID Model (Gunakan ini) | Nama Model | Status |\n')
              f.write('| :--- | :--- | :--- |\n')
              
              try:
                  models = list(genai.list_models())
                  available_count = 0
                  for m in models:
                      if 'generateContent' in m.supported_generation_methods:
                          f.write(f'| **`{m.name}`** | {m.display_name} | READY ‚úÖ |\n')
                          available_count += 1
                  
                  if available_count == 0:
                      f.write('| - | Tidak ada model yang mendukung generateContent | ‚ö†Ô∏è |\n')

                  f.write('\n\n### üõ†Ô∏è Solusi Error 404\n')
                  f.write('Jika Anda sebelumnya mendapatkan error 404, itu karena nama model di kode Anda tidak sesuai dengan daftar di atas.\n\n')
                  f.write('**Cara Memperbaiki:**\n')
                  f.write('1. Pilih ID dari tabel (misal: `models/gemini-1.5-pro-latest`).\n')
                  f.write('2. Ganti baris di kode Anda menjadi: `model = genai.GenerativeModel(\"models/gemini-1.5-pro-latest\")`.\n')
                  
              except Exception as e:
                  f.write(f'\n\n> ‚ùå **Gagal Mengambil Data:** {str(e)}\n')
          "

      - name: Commit and Push Report
        run: |
          git config --global user.name "Gemini-Reporter-Bot"
          git config --global user.email "bot@github.com"
          git add API_REPORT.md
          git commit -m "Update API Status Report [skip ci]" || echo "No changes to commit"
          git push
